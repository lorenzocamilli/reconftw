#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi

# Help menu
help_menu() {
	echo "$(basename "$0") [OPTIONS]"
	echo "Broken Links Check using katana and axiom"
	echo ""
	echo "Options:"
	echo "  -d, --deep              Set deep mode (optional)"
	echo "  -h, --help              Display this help message and exit"
	exit 0
}

# Input validation
DEEP_MODE=false
while [[ $1 != "" ]]; do
	case $1 in
	-d | --deep)
		DEEP_MODE=true
		;;
	-h | --help)
		help_menu
		exit
		;;
	*)
		echo "Unknown option: $1"
		exit 1
		;;
	esac
	shift
done

broken_links_check() {
	local deep_mode=$1

		# The code remains mostly unchanged, with only minor adjustments for clarity.
		[[ ! -s ".tmp/webs_all.txt" ]] && cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null | anew -q .tmp/webs_all.txt
		if [[ ! ${AXIOM} == true ]]; then
			depth_level=$([[ "$deep_mode" = true ]] && echo 3 || echo 2)
			[[ -s ".tmp/webs_all.txt" ]] && katana -silent -list .tmp/webs_all.txt -jc -kf all -c $KATANA_THREADS -d $depth_level -o .tmp/katana.txt 2>>"${LOGFILE}" >/dev/null
			[[ -s ".tmp/katana.txt" ]] && sed -i '/^.\{2048\}./d' .tmp/katana.txt
		else
			depth_level=$([[ "$deep_mode" = true ]] && echo 3 || echo 2)
			[[ -s ".tmp/webs_all.txt" ]] && axiom-scan .tmp/webs_all.txt -m katana -jc -kf all -d $depth_level -o .tmp/katana.txt "${AXIOM_EXTRA_ARGS}" 2>>"${LOGFILE}" >/dev/null
			[[ -s ".tmp/katana.txt" ]] && sed -i '/^.\{2048\}./d' .tmp/katana.txt
		fi
		[[ -s ".tmp/katana.txt" ]] && cat .tmp/katana.txt | sort -u | httpx -follow-redirects -random-agent -status-code -threads $HTTPX_THREADS -rl $HTTPX_RATELIMIT -timeout $HTTPX_TIMEOUT -silent -retries 2 -no-color | grep "\[4" | cut -d ' ' -f1 | anew -q .tmp/brokenLinks_total.txt
		NUMOFLINES=$(cat .tmp/brokenLinks_total.txt 2>>"${LOGFILE}" | anew vulns/brokenLinks.txt | sed '/^$/d' | wc -l)
		notification "${NUMOFLINES} new broken links found" info

}

broken_links_check $DEEP_MODE
