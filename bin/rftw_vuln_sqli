#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi

# Help menu function
function display_help() {
	echo "$(basename "$0") [OPTIONS]"
	echo
	echo "Perform SQLi checks on provided inputs."
	echo "Options:"
	echo "  -d, --deep    Perform deep scanning"
	echo "  -h, --help    Display this help and exit"
	echo
}

# Validate requirements function
function validate_requirements() {
	if ! [[ -x "$(command -v python3)" ]] || ! [[ -x "$(command -v interlace)" ]]; then
		echo "Error: python3 and/or interlace are not installed." >&2
		exit 1
	fi
	if [[ ${SQLMAP} == true ]] && ! [[ -f "${tools}/sqlmap/sqlmap.py" ]]; then
		echo "Error: sqlmap.py not found at specified location." >&2
		exit 1
	fi
}

# SQLi checks function
function sqli_checks() {
	local deep_flag=$1
	echo "[*] Starting SQLi checks"
	cat gf/sqli.txt | qsreplace FUZZ | sed '/FUZZ/!d' | anew -q .tmp/tmp_sqli.txt
	if [[ $deep_flag == true ]] || [[ $(cat .tmp/tmp_sqli.txt | wc -l) -le $DEEP_LIMIT ]]; then
		if [[ ${SQLMAP} == true ]]; then
			python3"${tools}"/sqlmap/sqlmap.py -m .tmp/tmp_sqli.txt -b -o --smart --batch --disable-coloring --random-agent --output-dir=vulns/sqlmap 2>>"${LOGFILE}" >/dev/null
		fi
		if [[ ${GHAURI} == true ]]; then
			interlace -tL .tmp/tmp_sqli.txt -threads "${INTERLACE_THREADS}" -c "ghauri -u _target_ --batch -H \"${HEADER}\" --force-ssl >> vulns/ghauri_log.txt" 2>>"${LOGFILE}" >/dev/null
		fi
		echo "[+] Results are saved in vulns/sqlmap folder"
	else
		echo "[!] Skipping SQLi: Too many URLs to test, try with --deep flag"
	fi
}

# Main script execution
deep_flag=false

while (("$#")); do
	case "$1" in
	-d | --deep)
		deep_flag=true
		shift
		;;
	-h | --help)
		display_help
		exit 0
		;;
	*)
		echo "Unknown parameter passed: $1"
		display_help
		exit 1
		;;
	esac
done

validate_requirements
sqli_checks $deep_flag
