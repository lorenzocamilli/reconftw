#!/bin/bash

# Load environment variables from reconftw.cfg
# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

# Help function
help_menu() {
    echo "$(basename "$0") [OPTIONS]"
    echo ""
    echo "Templates Based Web Scanner"
    echo ""
    echo "Options:"
    echo "  -h, --help            Show this help menu"
    echo "  -f, --force           Force the execution even if already processed"
}

# Start function
start_func() {
    echo "Starting $1: $2..."
}

# End function
end_func() {
    echo "$1"
    echo "End of $2..."
}

# Default values
FORCE=false

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) help_menu; exit 0 ;;
        -f|--force) FORCE=true ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

if { [ ! -f "$called_fn_dir/.nuclei_check" ] || [ "$FORCE" = true ]; } && [ "$NUCLEICHECK" = true ]; then
    start_func "nuclei_check" "Templates based web scanner"
    nuclei -update 2>>"$LOGFILE" >/dev/null
    mkdir -p nuclei_output
    
    anew -q .tmp/webs_all.txt < <(cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null)
    anew -q .tmp/webs_subs.txt < <(cat subdomains/subdomains.txt .tmp/webs_all.txt 2>>"$LOGFILE")
    
    if [ ! "$AXIOM" = true ]; then
        IFS=',' read -ra severity_array <<< "$NUCLEI_SEVERITY"
        for crit in "${severity_array[@]}"
        do
            printf "${yellow}\n Running : Nuclei $crit ${reset}\n\n"
            nuclei $NUCLEI_FLAGS -severity $crit -nh -rl $NUCLEI_RATELIMIT -o nuclei_output/${crit}.txt < .tmp/webs_subs.txt
        done
        printf "\n\n"
    else
        if [ -s ".tmp/webs_subs.txt" ]; then
            IFS=',' read -ra severity_array <<< "$NUCLEI_SEVERITY"
            for crit in "${severity_array[@]}"
            do
                printf "${yellow}\n Running : Nuclei $crit, check results on nuclei_output folder${reset}\n\n"
                axiom-scan .tmp/webs_subs.txt -m nuclei --nuclei-templates ${NUCLEI_TEMPLATES_PATH} -severity ${crit} -nh -rl $NUCLEI_RATELIMIT -o nuclei_output/${crit}.txt $AXIOM_EXTRA_ARGS 2>>"$LOGFILE" >/dev/null
                [ -s "nuclei_output/${crit}.txt" ] && cat nuclei_output/${crit}.txt
            done
            printf "\n\n"
        fi
    fi
    end_func "Results are saved in $domain/nuclei_output folder" "nuclei_check"
else
    if [ "$NUCLEICHECK" = false ]; then
        printf "\n${yellow} nuclei_check skipped in this mode or defined in reconftw.cfg ${reset}\n"
    else
        printf "${yellow} nuclei_check is already processed. To force executing nuclei_check, delete\n    $called_fn_dir/.nuclei_check ${reset}\n\n"
    fi
fi
