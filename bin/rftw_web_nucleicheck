#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi

# Help function
help_menu() {
	echo "$(basename "$0") [OPTIONS]"
	echo ""
	echo "Templates Based Web Scanner"
	echo ""
	echo "Options:"
	echo "  -h, --help            Show this help menu"
	echo "  -f, --force           Force the execution even if already processed"
}

# Start function
start_func() {
	echo "Starting $1: $2..."
}

# End function
end_func() {
	echo "$1"
	echo "End of $2..."
}

# Parse arguments
while [[ $# -gt 0 ]]; do
	case $1 in
	-h | --help)
		help_menu
		exit 0
		;;
	*)
		echo "Unknown parameter passed: $1"
		exit 1
		;;
	esac
	shift
done

nuclei -update 2>>"${LOGFILE}" >/dev/null
mkdir -p nuclei_output
anew -q .tmp/webs_all.txt < <(cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null)
anew -q .tmp/webs_subs.txt < <(cat subdomains/subdomains.txt .tmp/webs_all.txt 2>>"${LOGFILE}")
if [[ ${AXIOM} != true ]]; then
	IFS=',' read -ra severity_array <<<"$NUCLEI_SEVERITY"
	for crit in "${severity_array[@]}"; do
		printf "${yellow}\n Running : Nuclei $crit ${reset}\n\n"
		nuclei $NUCLEI_FLAGS -severity $crit -nh -rl $NUCLEI_RATELIMIT -o nuclei_output/${crit}.txt <.tmp/webs_subs.txt
	done
	printf "\n\n"
else
	if [[ -s ".tmp/webs_subs.txt" ]]; then
		IFS=',' read -ra severity_array <<<"$NUCLEI_SEVERITY"
		for crit in "${severity_array[@]}"; do
			printf "${yellow}\n Running : Nuclei $crit, check results on nuclei_output folder${reset}\n\n"
			axiom-scan .tmp/webs_subs.txt -m nuclei --nuclei-templates ${NUCLEI_TEMPLATES_PATH} -severity ${crit} -nh -rl $NUCLEI_RATELIMIT -o nuclei_output/${crit}.txt "${AXIOM_EXTRA_ARGS}" 2>>"${LOGFILE}" >/dev/null
			[[ -s "nuclei_output/${crit}.txt" ]] && cat nuclei_output/${crit}.txt
		done
		printf "\n\n"
	fi
fi
