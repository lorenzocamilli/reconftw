#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi
# Help menu
display_help() {
	echo "$(basename "$0") [Options]"
	echo
	echo "  -f, --file              File containing IPs for port scan (Required)"
	echo "  -o, --output-dir        Output dir location"
	echo "  -h, --help              Display this help and exit"
	echo
	echo "Example: $0 -f file.txt -o dir"
	exit 1
}

# Parse input arguments
while [[ $# -gt 0 ]]; do
	case $1 in
	-f | --file)
		DOMAIN_FILE="$2"
		shift
		;;
	-o | --output)
		OUTPUT_FILE="$2"
		shift
		;;
	-h | --help) display_help ;;
	*)
		echo "Unknown parameter passed: $1"
		exit 1
		;;
	esac
	shift
done

# Input validation
if [[ -z ${DOMAIN_FILE} ]] ; then
	display_help
	exit 1
fi

# Validate file
if [[ ! -f ${DOMAIN_FILE} ]] || [[ ! -r ${DOMAIN_FILE} ]]; then
	echo "Error: Specified file does not exist or is not readable."
	exit 1
fi

# Handle the output of the cdncheck command based on the presence of the -o flag
if [[ -z ${OUTPUT_FILE} ]]; then
	cdncheck -silent -resp -nc <"${DOMAIN_FILE}"
else
	cdncheck -silent -resp -nc <"${DOMAIN_FILE}" >temp.txt
	sort -u temp.txt >"${OUTPUT_FILE}"
	rm temp.txt
fi
