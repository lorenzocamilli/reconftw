#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi

# Help menu
function help_menu() {
    echo -e "Usage: ./rftw_osint_metadata.sh [OPTIONS]"
    echo -e "Options:"
    echo -e "  -d, --domain DOMAIN       Specify the domain"
    echo -e "  -o, --output DIR          Specify the output file path (prints to stdout if not set)"
    echo -e "  -h, --help                Display this help menu"
    exit 1
}

# Main function
function gather_metadata() {
    echo -e "${yellow}Scanning metadata in public files${reset}"
    metafinder -d "${DOMAIN}" -l "${METAFINDER_LIMIT}" -o ${output_file} -go -bi -ba &>/dev/null || { echo "metafinder command failed"; exit 1; }
     if [[ -d "${output_file}/${DOMAIN}/" ]]; then
        if [[ -n $(ls -A "${output_file}/${DOMAIN}/") ]]; then
            mv "${output_file}/${DOMAIN}/*.txt" "${output_file}/"
            rm -rf "${output_file}/${DOMAIN}"
        fi
    fi
}

# Default values
DOMAIN=""
output_file=""

# Parse command-line arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -d|--domain) DOMAIN="$2"; shift ;;
        -o|--output) output_file="$2"; shift ;;
        -h|--help) help_menu ;;
        *) echo -e "${bred}Unknown parameter passed: $1${reset}" >&2; help_menu ;;
    esac
    shift
done

# Validate the domain using the utility script
rftw_util_validatedomain "${DOMAIN}" || exit 1

# Validate inputs
if [[ -z "${DOMAIN}" ]]; then
    echo -e "${bred}Error: Missing required parameters.${reset}" >&2
    help_menu
    exit 1
fi

# Execute the main function
gather_metadata
