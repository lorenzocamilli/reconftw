#!/bin/bash

# Load environment variables from reconftw.cfg
# Load environment variables
if [[ -f "reconftw.cfg" ]]; then
	source reconftw.cfg
else
	echo "Error: reconftw.cfg not found!"
	exit 1
fi

# Help menu function
function display_help() {
	echo "$(basename "$0") [MODE]"
	echo
	echo "Shut down the Axiom fleet based on configurations in reconftw.cfg."
	echo
	echo "MODE: Specifies the mode for the shutdown. (e.g., 'subs_menu', 'passive', 'all')"
	echo
	echo "Options:"
	echo "  -h, --help    Display this help and exit"
	echo
}

# Main Axiom shutdown function
function axiom_shutdown() {
	local mode="$1"
	if [[ "${AXIOM_FLEET_LAUNCH}" == true ]] && [[ "${AXIOM_FLEET_SHUTDOWN}" == true ]] && [[ -n ${AXIOM_FLEET_NAME} ]]; then
		# Check mode conditions
		if [[ ${mode} == "subs_menu" || ${mode} == "passive" || ${mode} == "all" ]]; then
			# You might want to add a logging function here for "notification"
			# notification "Automatic Axiom fleet shutdown is not enabled in this mode" info
			echo "Automatic Axiom fleet shutdown is not enabled in mode: $mode"
			return
		fi

		# Remove the Axiom fleet
		eval axiom-rm -f "${AXIOM}_FLEET_NAME*"
		echo "Axiom fleet ${AXIOM}_FLEET_NAME shutdown" | ${NOTIFY}
		# Another potential place for a logging function
		# notification "Axiom fleet ${AXIOM}_FLEET_NAME shutdown" info
		echo "Axiom fleet ${AXIOM}_FLEET_NAME shutdown"
	else
		echo "Axiom fleet conditions not met for shutdown."
	fi
}

# Check arguments
if [[ $1 == "-h" || $1 == "--help" ]]; then
	display_help
	exit 0
else
	# Ensure mode is specified
	if [[ -z $1 ]]; then
		echo "Error: Mode not specified."
		display_help
		exit 1
	fi
	axiom_shutdown "$1"
fi
