#!/bin/bash

# Load environment variables
if [[ -f "reconftw.cfg" ]]; then
	source reconftw.cfg
else
	echo "Error: reconftw.cfg not found!"
	exit 1
fi

# Help menu function
function display_help() {
	echo "$(basename "$0") [OPTIONS]"
	echo
	echo "Perform HTTP Request Smuggling checks on provided inputs."
	echo "Options:"
	echo "  -h, --help    Display this help and exit"
	echo
}

# Validate requirements function
function validate_requirements() {
	if ! [[ -x "$(command -v python3)" ]]; then
		echo "Error: python3 not found." >&2
		exit 1
	fi
	if ! [[ -d "${tools}/smuggler" ]]; then
		echo "Error: smuggler tool directory not found." >&2
		exit 1
	fi
}

# HTTP Request Smuggling test function
function smuggling_test() {
	echo "[*] Starting HTTP Request Smuggling checks"
	[[ ! -s ".tmp/webs_all.txt" ]] && cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null | anew -q .tmp/webs_all.txt
	if [[ $DEEP == true ]] || [[ $(cat .tmp/webs_all.txt | wc -l) -le $DEEP_LIMIT ]]; then
		cd "${tools}/smuggler" || {
			echo "Failed to cd directory in smuggling @ line $LINENO"
			exit 1
		}
		cat "${dir}"/.tmp/webs_all.txt | python3 smuggler.py -q --no-color 2>/dev/null | anew -q "${dir}"/.tmp/smuggling.txt
		cd "${dir}" || {
			echo "Failed to cd to $dir in smuggling @ line $LINENO"
			exit 1
		}
		[[ -s ".tmp/smuggling.txt" ]] && cat .tmp/smuggling.txt | anew -q vulns/smuggling.txt
		echo "[+] Results are saved in vulns/smuggling.txt"
	else
		echo "[!] Skipping HTTP Request Smuggling: Too many webs to test, try with --deep flag"
	fi
}

# Main script execution
while (("$#")); do
	case "$1" in
	-h | --help)
		display_help
		exit 0
		;;
	*)
		echo "Unknown parameter passed: $1"
		display_help
		exit 1
		;;
	esac
done

validate_requirements
smuggling_test
