#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi

# Help menu function
function display_help() {
	echo "$(basename "$0") [OPTIONS]"
	echo
	echo "Perform Password spraying tests on provided inputs."
	echo "Options:"
	echo "  -h, --help    Display this help and exit"
	echo
}

# Validate requirements function
function validate_requirements() {
	if ! [[ -x "$(command -v python3)" ]]; then
		echo "Error: python3 not found." >&2
		exit 1
	fi
	if ! [[ -f "${dir}/hosts/portscan_active.gnmap" ]]; then
		echo "Error: portscan_active.gnmap not found." >&2
		exit 1
	fi
}

# Password spraying test function
function spraying_test() {
	echo "[*] Starting Password spraying"
	cd "${tools}/brutespray" || {
		echo "Failed to cd directory in spraying_test @ line ${LINENO}"
		exit 1
	}
	python3 brutespray.py --file "${dir}"/hosts/portscan_active.gnmap --threads "${BRUTESPRAY_THREADS}" --hosts "${BRUTESPRAY_CONCURRENCE}" -o "${dir}"/vulns/brutespray
	cd "${dir}" || {
		echo "Failed to cd directory in spraying_test @ line ${LINENO}"
		exit 1
	}
	echo "[+] Results are saved in vulns/brutespray folder"
}

# Main script execution
while (("$#")); do
	case "$1" in
	-h | --help)
		display_help
		exit 0
		;;
	*)
		echo "Unknown parameter passed: $1"
		display_help
		exit 1
		;;
	esac
done

validate_requirements
spraying_test
