#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi

help_menu() {
    echo "$(basename "$0") [OPTIONS]"
    echo "Subdomain and DNS takeover checker."
    echo
    echo "Options:"
    echo "  -h, --help   Display this help menu and exit"
    echo "  -f, --force  Force the execution even if it was already processed"
}

validate_inputs() {
    if [[ "$SUBTAKEOVER" != true ]] && [[ "$FORCE_EXECUTION" != true ]]; then
        echo -e "${yellow} subtakeover skipped in this mode or defined in reconftw.cfg ${reset}"
        exit 0
    fi
}

run_subtakeover() {
    start_func ${FUNCNAME[0]} "Looking for possible subdomain and DNS takeover"
		touch .tmp/tko.txt
		[[ ! -s ".tmp/webs_all.txt" ]] && cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null | anew -q .tmp/webs_all.txt
		if [[ ! ${AXIOM} = true ]]; then
			nuclei -update 2>>"${LOGFILE}" >/dev/null
			cat subdomains/subdomains.txt .tmp/webs_all.txt 2>/dev/null | nuclei -silent -nh -tags takeover -severity info,low,medium,high,critical -retries 3 -rl $NUCLEI_RATELIMIT -t ${NUCLEI_TEMPLATES_PATH} -o .tmp/tko.txt
		else
			cat subdomains/subdomains.txt .tmp/webs_all.txt 2>>"${LOGFILE}" | sed '/^$/d' | anew -q .tmp/webs_subs.txt
			[[ -s ".tmp/webs_subs.txt" ]] && axiom-scan .tmp/webs_subs.txt -m nuclei --nuclei-templates ${NUCLEI_TEMPLATES_PATH} -tags takeover -nh -severity info,low,medium,high,critical -retries 3 -rl $NUCLEI_RATELIMIT -t ${NUCLEI_TEMPLATES_PATH} -o .tmp/tko.txt "${AXIOM_EXTRA_ARGS}" 2>>"${LOGFILE}" >/dev/null
		fi

		# DNS_TAKEOVER
		cat .tmp/subs_no_resolved.txt .tmp/subdomains_dns.txt .tmp/scrap_subs.txt .tmp/analytics_subs_clean.txt .tmp/passive_recursive.txt 2>/dev/null | anew -q .tmp/subs_dns_tko.txt
		cat .tmp/subs_dns_tko.txt 2>/dev/null | dnstake -c $DNSTAKE_THREADS -s 2>>"${LOGFILE}" | sed '/^$/d' | anew -q .tmp/tko.txt

		sed -i '/^$/d' .tmp/tko.txt

		NUMOFLINES=$(cat .tmp/tko.txt 2>>"${LOGFILE}" | anew webs/takeover.txt | sed '/^$/d' | wc -l)
		if [[ "$NUMOFLINES" -gt 0 ]]; then
			notification "${NUMOFLINES} new possible takeovers found" info
		fi
		end_func "Results are saved in ${DOMAIN}/webs/takeover.txt" ${FUNCNAME[0]}
}

# Main
FORCE_EXECUTION=false

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) help_menu; exit 0 ;;
        -f|--force) FORCE_EXECUTION=true; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

validate_inputs
run_subtakeover