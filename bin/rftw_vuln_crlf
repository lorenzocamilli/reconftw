#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi

# Help menu function
function display_help() {
    echo "$(basename "$0") [OPTIONS]"
    echo
    echo "Perform CRLF checks on provided inputs."
    echo "Options:"
    echo "  -d, --deep    Perform deep scanning"
    echo "  -h, --help    Display this help and exit"
    echo
}

# Validate requirements function
function validate_requirements() {
    if ! [[ -x "$(command -v crlfuzz)" ]]; then
        echo "Error: crlfuzz is not installed." >&2
        exit 1
    fi
}

# CRLF checks function
function crlf_checks() {
    local deep_flag=$1

    if { [[ ! -f "${called_fn_dir}/.crlf_checks" ]] || [[ "$DIFF" = true ]]; } && [[ "$CRLF_CHECKS" = true ]]; then
        echo "[*] Starting CRLF checks"
        
        if [[ ! -s ".tmp/webs_all.txt" ]]; then
            cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null | anew -q .tmp/webs_all.txt
        fi
        
        if [[ "$deep_flag" = true ]] || [[ $(cat .tmp/webs_all.txt | wc -l) -le $DEEP_LIMIT ]]; then
            crlfuzz -l .tmp/webs_all.txt -o vulns/crlf.txt 2>>"${LOGFILE}" >/dev/null
            echo "[+] Results are saved in vulns/crlf.txt"
        else
            echo "[!] Skipping CRLF: Too many URLs to test, try with --deep flag"
        fi
    else
        if [[ "$CRLF_CHECKS" = false ]]; then
            echo -e "\n${yellow} crlf_checks skipped in this mode or defined in reconftw.cfg ${reset}"
        else
            echo -e "${yellow} crlf_checks is already processed, to force executing crlf_checks delete\n    $called_fn_dir/.crlf_checks ${reset}\n"
        fi
    fi
}

# Main script execution
deep_flag=false

while (( "$#" )); do
    case "$1" in
        -d|--deep)
            deep_flag=true
            shift
            ;;
        -h|--help)
            display_help
            exit 0
            ;;
        *) 
            echo "Unknown parameter passed: $1"
            display_help
            exit 1
            ;;
    esac
done

validate_requirements
crlf_checks $deep_flag
